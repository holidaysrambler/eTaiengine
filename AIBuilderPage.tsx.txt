"use client"

import { useState, useEffect } from "react"
import { motion } from "framer-motion"
import ParticlesBackground from "./ParticlesBackground"
import LivePreviewPane from "./LivePreviewPane"
import PuterCloudDeploy from "./PuterCloudDeploy"
import { generateUIWithPuter, availableModels, isPuterEnvironment } from "@/lib/puterAI"
import { Loader2 } from "lucide-react"

export default function AIBuilderPage() {
  const [prompt, setPrompt] = useState("")
  const [generatedCode, setGeneratedCode] = useState("")
  const [isGenerating, setIsGenerating] = useState(false)
  const [selectedModel, setSelectedModel] = useState("claude-sonnet-4-5")
  const [error, setError] = useState("")
  const [puterReady, setPuterReady] = useState(false)

  useEffect(() => {
    const checkPuter = () => {
      try {
        if (isPuterEnvironment()) {
          console.log("[v0] Puter API detected and ready")
          setPuterReady(true)
          return true
        }
      } catch (err) {
        console.error("[v0] Error checking Puter:", err)
      }
      return false
    }

    if (!checkPuter()) {
      console.log("[v0] Waiting for Puter API to load...")
      const interval = setInterval(() => {
        if (checkPuter()) {
          clearInterval(interval)
        }
      }, 500)

      setTimeout(() => {
        clearInterval(interval)
        if (!isPuterEnvironment()) {
          console.warn("[v0] Puter API not detected after timeout")
          setPuterReady(false)
        }
      }, 10000)

      return () => clearInterval(interval)
    }
  }, [])

  const handleGenerate = async () => {
    if (!prompt.trim()) return

    setIsGenerating(true)
    setError("")

    try {
      console.log("[v0] Starting generation with model:", selectedModel)
      const code = await generateUIWithPuter(prompt, selectedModel)
      setGeneratedCode(code)
      console.log("[v0] Generation complete")
    } catch (error) {
      console.error("[v0] Generation error:", error)
      setError(
        `Failed to generate UI: ${error instanceof Error ? error.message : "Unknown error"}. ${!puterReady ? "Puter API is still loading, please wait a moment and try again." : ""}`,
      )
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <section
      id="ai-builder"
      className="relative min-h-screen py-20 flex flex-col items-center justify-center text-white overflow-hidden"
    >
      <ParticlesBackground />

      <div className="relative z-10 container mx-auto px-6">
        <motion.h2
          className="text-5xl md:text-6xl font-bold font-space-grotesk mb-6 text-center"
          initial={{ opacity: 0, y: -30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          AI-Powered UI Builder
        </motion.h2>
        <motion.p
          className="text-xl text-gray-300 font-inter mb-10 max-w-3xl mx-auto text-center"
          initial={{ opacity: 0 }}
          whileInView={{ opacity: 1 }}
          viewport={{ once: true }}
        >
          Transform your ideas into beautiful interfaces instantly with multi-model AI support.
        </motion.p>

        <motion.div className="mb-4 text-center" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
          <div
            className={`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm ${puterReady ? "bg-green-500/20 text-green-400 border border-green-500/30" : "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30"}`}
          >
            <div className={`w-2 h-2 rounded-full ${puterReady ? "bg-green-400" : "bg-yellow-400 animate-pulse"}`} />
            {puterReady ? "Keyless API Active - No API Keys Required!" : "Initializing Puter..."}
          </div>
        </motion.div>

        <motion.div
          className="glow-border bg-[#1a1a2e] p-8 rounded-2xl mb-8"
          initial={{ opacity: 0, y: 30 }}
          whileInView={{ opacity: 1, y: 0 }}
          viewport={{ once: true }}
        >
          <div className="flex flex-col gap-4">
            <div>
              <label className="block text-sm font-semibold text-gray-300 mb-2">Select AI Model</label>
              <select
                value={selectedModel}
                onChange={(e) => setSelectedModel(e.target.value)}
                className="w-full bg-[#2d2d44] border border-purple-500/50 rounded-xl p-4 text-white font-inter focus:outline-none focus:border-purple-500 transition-colors"
                disabled={isGenerating}
              >
                {availableModels.map((model) => (
                  <option key={model.id} value={model.id}>
                    {model.name} ({model.provider})
                  </option>
                ))}
              </select>
            </div>

            <textarea
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder="Describe your UI... (e.g., 'Create a modern landing page with a hero section and pricing cards')"
              className="w-full h-32 bg-[#2d2d44] border border-purple-500/50 rounded-xl p-4 text-gray-200 font-inter resize-none focus:outline-none focus:border-purple-500 transition-colors"
              disabled={isGenerating}
            />

            {error && (
              <div className="text-red-400 text-sm bg-red-500/10 border border-red-500/20 rounded-lg p-3">{error}</div>
            )}

            <motion.button
              onClick={handleGenerate}
              disabled={isGenerating || !prompt.trim()}
              className="bg-purple-600 text-white px-8 py-4 rounded-xl text-xl font-bold button-glow disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              whileHover={{ scale: !isGenerating ? 1.03 : 1 }}
              whileTap={{ scale: !isGenerating ? 0.98 : 1 }}
            >
              {isGenerating ? (
                <>
                  <Loader2 className="w-5 h-5 animate-spin" />
                  Generating with {availableModels.find((m) => m.id === selectedModel)?.name}...
                </>
              ) : (
                "Generate UI"
              )}
            </motion.button>
          </div>
        </motion.div>

        {generatedCode && (
          <motion.div
            className="glow-border bg-[#1a1a2e] p-8 rounded-2xl mb-8"
            initial={{ opacity: 0, y: 30 }}
            animate={{ opacity: 1, y: 0 }}
          >
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="flex flex-col">
                <h3 className="text-2xl font-space-grotesk text-purple-400 mb-4">Generated Code</h3>
                <div className="bg-[#0a0a0f] border border-purple-500/50 rounded-xl p-4 overflow-auto h-96 font-mono text-sm text-gray-300">
                  <pre className="whitespace-pre-wrap">{generatedCode}</pre>
                </div>
              </div>

              <LivePreviewPane code={generatedCode} />
            </div>

            <PuterCloudDeploy code={generatedCode} />
          </motion.div>
        )}
      </div>
    </section>
  )
}
